"""update_service_api

Revision ID: 25fc64df7326
Revises: 10c58e701d87
Create Date: 2023-03-02 16:21:13.680443

"""
import sqlalchemy as sa
from alembic import op

from ai.backend.manager.models.base import GUID

# revision identifiers, used by Alembic.
revision = "25fc64df7326"
down_revision = "10c58e701d87"
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###

    # Drop constraints and indexes
    op.drop_index("ix_endpoints_resource_group", table_name="endpoints")
    op.drop_constraint("uq_routings_endpoint_session", "routings", type_="unique")
    op.drop_constraint("fk_routings_session_sessions", "routings", type_="foreignkey")
    op.drop_constraint("fk_routings_endpoint_endpoints", "routings", type_="foreignkey")

    # Alter column name
    op.alter_column("endpoints", column_name="image", new_column_name="image_id")
    op.alter_column("endpoints", column_name="model", new_column_name="model_id")
    op.alter_column("endpoints", column_name="domain", new_column_name="domain_name")
    op.alter_column("endpoints", column_name="project", new_column_name="project_id")
    op.alter_column(
        "endpoints", column_name="resource_group", new_column_name="resource_group_name"
    )
    op.alter_column("endpoints", "resource_slots", nullable=True, server_default="{}")

    op.alter_column("routings", column_name="endpoint", new_column_name="endpoint_id")
    op.alter_column("routings", column_name="session", new_column_name="session_id")

    # Add columns
    op.add_column(
        "routings", sa.Column("session_endpoint_name", sa.String(length=256), nullable=True)
    )
    op.add_column("routings", sa.Column("session_endpoint_port", sa.Integer(), nullable=True))
    op.add_column("routings", sa.Column("model_version", sa.String(length=64), nullable=False))
    op.add_column("routings", sa.Column("model_id", GUID(), nullable=False))

    # Add constraints and indexes
    op.create_index(
        op.f("ix_endpoints_resource_group_name"), "endpoints", ["resource_group_name"], unique=False
    )
    op.drop_constraint(
        "fk_endpoints_resource_group_scaling_groups", "endpoints", type_="foreignkey"
    )
    op.drop_constraint("fk_endpoints_project_groups", "endpoints", type_="foreignkey")
    op.drop_constraint("fk_endpoints_domain_domains", "endpoints", type_="foreignkey")
    op.drop_constraint("fk_endpoints_image_images", "endpoints", type_="foreignkey")
    op.drop_constraint("fk_endpoints_model_vfolders", "endpoints", type_="foreignkey")
    op.create_foreign_key(
        op.f("fk_endpoints_image_id_images"),
        "endpoints",
        "images",
        ["image_id"],
        ["id"],
        ondelete="RESTRICT",
    )
    op.create_foreign_key(
        op.f("fk_endpoints_project_id_groups"),
        "endpoints",
        "groups",
        ["project_id"],
        ["id"],
        ondelete="RESTRICT",
    )
    op.create_foreign_key(
        op.f("fk_endpoints_model_id_vfolders"),
        "endpoints",
        "vfolders",
        ["model_id"],
        ["id"],
        ondelete="RESTRICT",
    )
    op.create_foreign_key(
        op.f("fk_endpoints_resource_group_name_scaling_groups"),
        "endpoints",
        "scaling_groups",
        ["resource_group_name"],
        ["name"],
        ondelete="RESTRICT",
    )
    op.create_foreign_key(
        op.f("fk_endpoints_domain_name_domains"),
        "endpoints",
        "domains",
        ["domain_name"],
        ["name"],
        ondelete="RESTRICT",
    )
    op.create_unique_constraint(
        "uq_routings_endpoint_session", "routings", ["endpoint_id", "session_id"]
    )
    op.create_foreign_key(
        op.f("fk_routings_endpoint_id_endpoints"),
        "routings",
        "endpoints",
        ["endpoint_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        op.f("fk_routings_session_id_sessions"),
        "routings",
        "sessions",
        ["session_id"],
        ["id"],
        ondelete="RESTRICT",
    )
    op.create_foreign_key(
        op.f("fk_routings_model_id_vfolders"),
        "routings",
        "vfolders",
        ["model_id"],
        ["id"],
        ondelete="RESTRICT",
    )
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###

    # Drop constraints and indexes
    op.drop_constraint(op.f("fk_routings_model_id_vfolders"), "routings", type_="foreignkey")
    op.drop_constraint(op.f("fk_routings_session_id_sessions"), "routings", type_="foreignkey")
    op.drop_constraint(op.f("fk_routings_endpoint_id_endpoints"), "routings", type_="foreignkey")
    op.drop_constraint("uq_routings_endpoint_session", "routings", type_="unique")
    op.drop_constraint(op.f("fk_endpoints_domain_name_domains"), "endpoints", type_="foreignkey")
    op.drop_constraint(
        op.f("fk_endpoints_resource_group_name_scaling_groups"), "endpoints", type_="foreignkey"
    )
    op.drop_constraint(op.f("fk_endpoints_model_id_vfolders"), "endpoints", type_="foreignkey")
    op.drop_constraint(op.f("fk_endpoints_project_id_groups"), "endpoints", type_="foreignkey")
    op.drop_constraint(op.f("fk_endpoints_image_id_images"), "endpoints", type_="foreignkey")
    op.drop_index(op.f("ix_endpoints_resource_group_name"), table_name="endpoints")

    # Drop columns
    op.drop_column("routings", "model_version")
    op.drop_column("routings", "session_endpoint_port")
    op.drop_column("routings", "session_endpoint_name")
    op.drop_column("routings", "model_id")

    # Alter column name
    op.alter_column("endpoints", column_name="image_id", new_column_name="image")
    op.alter_column("endpoints", column_name="model_id", new_column_name="model")
    op.alter_column("endpoints", column_name="domain_name", new_column_name="domain")
    op.alter_column("endpoints", column_name="project_id", new_column_name="project")
    op.alter_column(
        "endpoints", column_name="resource_group_name", new_column_name="resource_group"
    )
    op.alter_column("endpoints", "resource_slots", nullable=False)

    op.alter_column("routings", column_name="endpoint_id", new_column_name="endpoint")
    op.alter_column("routings", column_name="session_id", new_column_name="session")

    # Add constraints and indexes
    op.create_foreign_key(
        "fk_routings_endpoint_endpoints",
        "routings",
        "endpoints",
        ["endpoint"],
        ["id"],
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        "fk_routings_session_sessions",
        "routings",
        "sessions",
        ["session"],
        ["id"],
        ondelete="RESTRICT",
    )

    op.create_unique_constraint("uq_routings_endpoint_session", "routings", ["endpoint", "session"])

    op.create_foreign_key(
        "fk_endpoints_model_vfolders",
        "endpoints",
        "vfolders",
        ["model"],
        ["id"],
        ondelete="RESTRICT",
    )
    op.create_foreign_key(
        "fk_endpoints_image_images", "endpoints", "images", ["image"], ["id"], ondelete="RESTRICT"
    )
    op.create_foreign_key(
        "fk_endpoints_domain_domains",
        "endpoints",
        "domains",
        ["domain"],
        ["name"],
        ondelete="RESTRICT",
    )
    op.create_foreign_key(
        "fk_endpoints_project_groups",
        "endpoints",
        "groups",
        ["project"],
        ["id"],
        ondelete="RESTRICT",
    )
    op.create_foreign_key(
        "fk_endpoints_resource_group_scaling_groups",
        "endpoints",
        "scaling_groups",
        ["resource_group"],
        ["name"],
        ondelete="RESTRICT",
    )
    op.create_index("ix_endpoints_resource_group", "endpoints", ["resource_group"], unique=False)
    # ### end Alembic commands ###
